<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Live Mic Mixer</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<style>
  body {
    background: #111;
    color: #fff;
    font-family: 'Poppins', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
  }
  h1 { font-size: 1.8em; margin-bottom: 0.5em; }
  button, select, input[type=range] {
    margin: 0.4em;
    padding: 0.6em 1em;
    border: none;
    border-radius: 10px;
    background: #0d6efd;
    color: #fff;
    font-size: 1em;
  }
  button:hover { background: #0b5ed7; }
  .controls { display: flex; flex-direction: column; gap: 0.4em; }
  .meter {
    width: 200px;
    height: 20px;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 0.8em;
  }
  .meter-fill {
    height: 100%;
    background: limegreen;
    width: 0%;
    transition: width 0.1s linear;
  }
</style>
</head>
<body>
<h1>ðŸŽ¤ Live Mic Mixer</h1>
<div class="controls">
  <button id="startBtn">Start Mic</button>
  <button id="muteBtn">Mute</button>
  <label>Volume <input type="range" id="volumeSlider" min="0" max="2" value="1" step="0.01" /></label>
  <label>Gain <input type="range" id="gainSlider" min="0" max="3" value="1" step="0.01" /></label>
  <label>Echo Time <input type="range" id="delaySlider" min="0" max="1" value="0.2" step="0.01" /></label>
  <label>Feedback <input type="range" id="feedbackSlider" min="0" max="0.9" value="0.3" step="0.01" /></label>
  <label>Reverb Intensity <input type="range" id="reverbSlider" min="0" max="1" value="0.5" step="0.01" /></label>
  <label>Room Preset
    <select id="roomSelect">
      <option value="studio">Studio</option>
      <option value="smallHall">Small Hall</option>
      <option value="largeHall">Large Hall</option>
      <option value="echoChamber">Echo Chamber</option>
    </select>
  </label>
</div>
<div class="meter"><div class="meter-fill" id="meterFill"></div></div>
<p style="font-size:0.8em;margin-top:1em;color:#aaa;">
  Works offline. Connect your phone to a Bluetooth speaker before pressing Start.
</p>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

let audioCtx, micStream, micSource;
let gainNode, delayNode, feedbackGain, reverbNode, convolverGain, volumeNode;
let analyser, meterFill;
let mute = false;

async function setupMic() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
  micStream = stream;
  micSource = audioCtx.createMediaStreamSource(stream);

  gainNode = audioCtx.createGain();
  delayNode = audioCtx.createDelay(5.0);
  feedbackGain = audioCtx.createGain();
  volumeNode = audioCtx.createGain();
  reverbNode = audioCtx.createConvolver();
  convolverGain = audioCtx.createGain();

  feedbackGain.connect(delayNode);
  delayNode.connect(feedbackGain);

  await loadImpulseResponse();

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  meterFill = document.getElementById('meterFill');

  micSource.connect(gainNode);
  gainNode.connect(delayNode);
  gainNode.connect(convolverGain);

  convolverGain.connect(reverbNode);
  reverbNode.connect(volumeNode);

  delayNode.connect(volumeNode);

  volumeNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  visualize();
}

function visualize() {
  requestAnimationFrame(visualize);
  const dataArray = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteTimeDomainData(dataArray);
  let avg = dataArray.reduce((a,b)=>a+b)/dataArray.length;
  let level = Math.abs(avg-128)/128*100;
  meterFill.style.width = `${level}%`;
}

async function loadImpulseResponse() {
  const len = (audioCtx?.sampleRate || 44100) * 3;
  const impulse = audioCtx.createBuffer(2, len, audioCtx.sampleRate);
  for (let c = 0; c < 2; c++) {
    const chan = impulse.getChannelData(c);
    for (let i = 0; i < len; i++) {
      chan[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, 2);
    }
  }
  reverbNode.buffer = impulse;
}

document.getElementById('startBtn').onclick = async () => { await setupMic(); };
document.getElementById('muteBtn').onclick = () => {
  mute = !mute;
  volumeNode.gain.value = mute ? 0 : parseFloat(document.getElementById('volumeSlider').value);
  document.getElementById('muteBtn').textContent = mute ? 'Unmute' : 'Mute';
};
document.getElementById('volumeSlider').oninput = e => { if (!mute) volumeNode.gain.value = parseFloat(e.target.value); };
document.getElementById('gainSlider').oninput = e => { if (gainNode) gainNode.gain.value = parseFloat(e.target.value); };
document.getElementById('delaySlider').oninput = e => { if (delayNode) delayNode.delayTime.value = parseFloat(e.target.value); };
document.getElementById('feedbackSlider').oninput = e => { if (feedbackGain) feedbackGain.gain.value = parseFloat(e.target.value); };
document.getElementById('reverbSlider').oninput = e => { if (convolverGain) convolverGain.gain.value = parseFloat(e.target.value); };
document.getElementById('roomSelect').onchange = e => {
  const v = e.target.value;
  if (v === 'studio') { delayNode.delayTime.value = 0.05; feedbackGain.gain.value = 0.1; convolverGain.gain.value = 0.2; }
  else if (v === 'smallHall') { delayNode.delayTime.value = 0.2; feedbackGain.gain.value = 0.3; convolverGain.gain.value = 0.4; }
  else if (v === 'largeHall') { delayNode.delayTime.value = 0.5; feedbackGain.gain.value = 0.5; convolverGain.gain.value = 0.7; }
  else if (v === 'echoChamber') { delayNode.delayTime.value = 0.8; feedbackGain.gain.value = 0.7; convolverGain.gain.value = 0.9; }
};
</script>
</body>
</html>
